<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Edited for ThingJS 2020
-->

<script type="text/html" data-template-name="split">
    <div class="form-row"><span data-i18n="[html]split.intro"></span></div>
    <div class="form-row"><span data-i18n="[html]split.strBuff"></span></div>
    <div class="form-row">
        <label for="node-input-splt" style="padding-left:10px; margin-right:-10px;" data-i18n="split.splitUsing"></label>
        <input type="text" id="node-input-splt" style="width:70%">
        <input type="hidden" id="node-input-spltType">
    </div>
    <div class="form-row">
        <input type="checkbox" id="node-input-stream" style="margin-left:10px; vertical-align:top; width:auto;">
        <label for="node-input-stream" style="width:auto;" data-i18n="split.stream"></label>
    </div>
    <div class="form-row"><span data-i18n="[html]split.array"></span></div>
    <div class="form-row">
        <label for="node-input-arraySplt" style="padding-left:10px; margin-right:-10px;" data-i18n="split.splitUsing"></label>
        <input type="text" id="node-input-arraySplt" style="width:70%">
        <input type="hidden" id="node-input-arraySpltType">
    </div>
    <div class="form-row"><span data-i18n="[html]split.object"></span></div>
    <div class="form-row" style="padding-left: 10px"><span data-i18n="[html]split.objectSend"></span></div>
    <div class="form-row">
        <input type="checkbox" id="node-input-addname-cb" style="margin-left:10px; vertical-align:baseline; width:auto;">
        <label for="node-input-addname-cb" style="width:auto;" data-i18n="split.addname"></label>
        <input type="text" id="node-input-addname" style="width:70%">
    </div>
    <hr/>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('split',{
        category: 'sequence',
        color:"#E2D96E",
        defaults: {
            name: {value:""},
            splt: {value:"\\n"},
            spltType: {value:"str"},
            arraySplt: {value:1},
            arraySpltType: {value:"len"},
            stream: {value:false},
            addname: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "split.svg",
        label: function() {
            return this.name||this._("split.split");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            $("#node-input-splt").typedInput({
                default: 'str',
                typeField: $("#node-input-spltType"),
                types:[
                    'str',
                    'bin',
                    {value:"len", label:RED._("node-red:split.splitLength"),validate:/^\d+$/}
                ]
            });
            if (this.arraySplt === undefined) {
                $("#node-input-arraySplt").val(1);
            }
            $("#node-input-arraySplt").typedInput({
                default: 'len',
                typeField: $("#node-input-arraySpltType"),
                types:[
                    {value:"len", label:RED._("node-red:split.splitLength"),validate:/^\d+$/}
                ]
            });
            $("#node-input-addname").typedInput({
                typeField: $("#node-input-fnameType"),
                types:['msg']
            });

            $("#node-input-addname-cb").on("change", function() {
                $("#node-input-addname").prop('disabled',!this.checked);
            })
            if (this.addname === "") {
                $("#node-input-addname-cb").prop('checked',false);
                $("#node-input-addname").val('topic');
            } else {
                $("#node-input-addname-cb").prop('checked',true);
            }
            $("#node-input-addname-cb").change();
        },
        oneditsave: function() {
            if (!$("#node-input-addname-cb").prop('checked')) {
                $("#node-input-addname").val('');
            }
        },
        genThingJSCode: function() {
            var is_string = `let ch=${JSON.stringify(this.splt)},ims=$r.str.split($i.payload,ch),ln=ims.length;`
                          + `for(let f=0;f<ln;f++){$i=this.mki($i,ims[f],"string",f,f,ln);$i.parts.ch=ch;this.$n([$i])}`;
            var is_object = `let ln=0,i=0,pl=$$cpy($i.payload);for(let k in pl)ln++;for(let k in pl){`
                          + `$i=this.mki($i,pl[k],tp,k,i++,ln);`
                          + (this.addname.length ? `$i[${JSON.stringify(this.addname)}]=k;`: '')
                          + `this.$n([$i])}`;
            var is_array = `let pl=$$cpy($i.payload),seg=[],ind=0,`
                         + `cnt=JSON.parse($r.str.split(pl.length/${this.arraySplt}+0.5,".")[0]);`
                         + `for(let k in pl){seg.push(pl[k]);if(seg.length>=${this.arraySplt}){`
                         + `$i=this.mki($i,seg,tp,undefined,ind++,cnt);$i.parts.len=${this.arraySplt};`
                         + `this.$n([$i]);seg=[];`
                         + `}}if(seg.length>0){$i=this.mki($i,seg,tp,undefined,ind,cnt);$i.parts.len=${this.arraySplt};this.$n([$i]);}`;
            debugger;
            var make_msg = `this.mki=function($i,pl,t,k,i,c){$i.payload=pl;$i.parts={"id":this.mid,"type":t};`
                         + (
                            this.stream
                            ? `if(t==="string"){$g["_spt_"+this.id]=$g["_spt_"+this.id]||0;$i.parts.index=$g["_spt_"+this.id]++}else{$i.parts.index=i;$i.parts.key=k;$i.parts.count=c}`
                            : `$i.parts.index=i;$i.parts.key=k;$i.parts.count=c;`
                         )
                         + `return $i};`;
            return {
                requires: {
                    "str" : "string"
                },
                func : `${make_msg}`
                    + `let tp=typeof $i.payload;this.mid=$$mid();`
                    + `if(tp==="string"){${is_string}}`
                    + `else if((tp==="array")||($i.payload["length"])){tp="array";${is_array}}`
                    + `else if(tp==="object"){${is_object}}`
            };
        }
    });
</script>


<script type="text/html" data-template-name="join">
    <div class="form-row">
        <label data-i18n="join.mode.mode"></label>
        <select id="node-input-mode" style="width:200px;">
            <option value="auto" data-i18n="join.mode.auto"></option>
            <option value="custom" data-i18n="join.mode.custom"></option>
        </select>
    </div>
    <div class="node-row-custom">
        <div class="form-row node-row-property">
            <label data-i18n="join.combine"> </label>
            <input type="text" id="node-input-property" style="width:70%;">
            <input type="hidden" id="node-input-propertyType">
        </div>
        <div class="form-row">
            <label data-i18n="join.create"></label>
            <select id="node-input-build" style="width:70%;">
                <option value="string" data-i18n="join.type.string"></option>
                <option value="buffer" data-i18n="join.type.buffer"></option>
                <option value="array" data-i18n="join.type.array"></option>
                <option value="object" data-i18n="join.type.object"></option>
                <option value="merged" data-i18n="join.type.merged"></option>
            </select>
        </div>
        <div class="form-row node-row-key">
            <label style="vertical-align:top; margin-top:7px; width:auto; margin-right: 5px;" data-i18n="join.using"></label>
            <div style="display:inline-block">
                <input type="text" id="node-input-key" style="width:220px;"> <span data-i18n="join.key"></span>
            </div>
        </div>
        <div class="form-row node-row-joiner">
            <label for="node-input-joiner" data-i18n="join.joinedUsing"></label>
            <input type="text" id="node-input-joiner" style="width:70%">
            <input type="hidden" id="node-input-joinerType">
        </div>
        <div class="form-row node-row-trigger" id="trigger-row">
            <label style="width:auto;" data-i18n="join.send"></label>
            <ul>
                <li>
                    <label style="width:280px;" for="node-input-count" data-i18n="join.afterCount"></label> <input id="node-input-count" data-i18n="[placeholder]join.count" type="text" style="width:75px;">
                </li>
                <li class="node-row-accumulate" style="list-style-type:none;">
                    <input type="checkbox" id="node-input-accumulate" style="display:inline-block; width:20px; margin-left:20px; vertical-align:top;">  <label style="width: auto" for="node-input-accumulate" data-i18n="join.subsequent"></label>
                </li>
                <li>
                    <label style="width:280px;" for="node-input-timeout" data-i18n="join.afterTimeout"></label> <input id="node-input-timeout" data-i18n="[placeholder]join.seconds" type="text" style="width:75px;">
                </li>
                <li>
                    <label style="width:auto; padding-top:6px;" data-i18n="[html]join.complete"></label>
                </li>
            </ul>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-tips form-tips-auto hide" data-i18n="[html]join.tip"></div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('join',{
        category: 'sequence',
        color:"#E2D96E",
        defaults: {
            name: {value:""},
            mode: {value:"auto"},
            build: { value:"string"},
            property: { value:"payload", validate:RED.validators.typedInput("propertyType")},
            propertyType: { value:"msg"},
            key: {value:"topic"},
            joiner: { value:"\\n"},
            joinerType: { value:"str"},
            accumulate: { value:"false" },
            timeout: {value:""},
            count: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "join.svg",
        label: function() {
            return this.name||this._("join.join");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;

            $("#node-input-mode").on("change", function(e) {
                var val = $(this).val();
                $(".node-row-custom").toggle(val==='custom');
                $(".form-tips-auto").toggle((val==='auto'));
                if (val === "auto") {
                    $("#node-input-accumulate").attr('checked', false);
                }
                else if (val === "custom") {
                    $("#node-input-build").change();
                }
            });

            $("#node-input-build").on("change", function(e) {
                var val = $(this).val();
                $(".node-row-key").toggle(val==='object');
                $(".node-row-accumulate").toggle(val==='object' || val==='merged');
                $(".node-row-joiner").toggle(val==='string' || val==='buffer');
                $(".node-row-trigger").toggle(val!=='auto');
                if (val === 'string' || val==='buffer') {
                    $("#node-input-property").typedInput('types',['msg']);
                    $("#node-input-joiner").typedInput("show");
                } else {
                    $("#node-input-property").typedInput('types', ['msg', {
                        value: "full",
                        label: RED._("node-red:join.completeMessage"),
                        hasValue: false
                    }]);
                }
            });

            $("#node-input-joiner").typedInput({
                default: 'str',
                typeField: $("#node-input-joinerType"),
                types:['str', 'bin']
            });

            $("#node-input-property").typedInput({
                typeField: $("#node-input-propertyType"),
                types: ['msg', {
                    value: "full",
                    label: RED._("node-red:join.completeMessage"),
                    hasValue: false
                }]
            });

            $("#node-input-key").typedInput({
                types:['msg']
            });

            $("#node-input-build").change();
            $("#node-input-mode").change();
        },
        oneditsave: function() {
            var build = $("#node-input-build").val();
            if (build !== 'object' && build !== 'merged') {
                $("#node-input-accumulate").prop("checked",false);
            }
        },
        genThingJSCode: function() {
            var code = 'this.jid="_jn_"+this.$id;';
            var requires = {"str" : "string"};
            switch(this.mode || "auto") {
                case "auto":
                    var is_array  = `for(let i in $i.payload){acc.p.push($i.payload[i])}`;
                    var is_string = `acc.p.push($i.payload);`;
                    var is_object = `acc.p.push({"k":p.key,"v":$i.payload})`;
                    code  += `this.s=function($i,acc){`
                          +     `if(acc.t==="array"){$i.payload=acc.p}`
                          +     `else if(acc.t==="string"){$i.payload=$r.str.join(acc.p,acc.ch||"")}`
                          +     `else if(acc.t==="object"){$i.payload={}; for(let i in acc.p)$i.payload[acc.p[i].k]=acc.p[i].v}`
                          +     `else{$i.payload=acc.p}`
                          +     `$i.parts=undefined;this.$n([$i]);acc=null`
                          + `};`
                          + `let p=$i.parts,tp=$i.parts.type;`
                          + `let acc=$g[this.jid]||{"t":tp,"l":p.len,"c":p.count||1,"i":p.id,"p":[],"ch":p.ch};`
                          + `if(acc.t!==tp){this.s($i,acc)}`
                          + `if(tp==="array"){${is_array}}`
                          + `else if(tp==="object"){${is_object}}`
                          + `else if(tp==="string"){${is_string}}`
                          + `else{acc.p.push($i.payload)}`
                          + `if((p.index+1>=acc.c)||(p.id!==acc.i)||(acc.t!==tp)){this.s($i,acc)}`
                          + `$g[this.jid]=acc`
                    ;
                    break;
                case "custom":
                    code += `let pl=(this.full&&$$cpy($i))||$i[this.prop];`;
                    var apply_code = `$i.payload=$r.str.join(acc.p,this.joiner);`;
                    var push_code = `acc.p.push(pl);acc.c++;acc.i=$i;`;
                    switch (this.build) {
                        case `array`:
                            apply_code = `$i.payload=acc.p;`
                            break;
                        case `object`:
                            push_code = `acc.p.push({"k":$i[this.key],"v":$i[this.prop]||""});acc.c++;acc.i=$i;`;
                            apply_code = `$i.payload={};for(let i in acc.p){$i.payload[acc.p[i].k]=acc.p[i].v}`;
                            break;
                        case `merged`:
                            push_code = `acc.i=$i;acc.pl=acc.pl||{};`
                                      + `if(pl)for(let k in pl){acc.pl[k]=pl[k];acc.c++}`;
                            apply_code = `$i.payload=acc.pl;`;
                            break;
                    }
                    if(this.timeout) {
                        requires.timer='timers';
                        code += `$g[this.jid]===undefined&&setInterval(function(c){`
                            +      `let acc=$g[c.jid];`
                            +      `if(acc&&acc.c>0){`
                            +          `let $i=acc.i;`
                            +          `${apply_code}`
                            +          `c.$n([$i])`
                            +      `}`
                            +      `if(!c.accum)$g[c.jid]=null`
                            + `},this.to,this);`;
                    }
                    code += `let acc=$g[this.jid]||{"p":[],"c":0};`
                        + `${push_code}`
                        + `if($i.complete||(acc.c>=this.count)){`
                        +     `${apply_code}`
                        +     `!this.accum&&(acc=null);this.$n([$i])`
                        +  `}`
                        + `$g[this.jid]=acc;`
                    ;
                    break;
            }
            return {
                requires,
                env: {
                    'count': this.count || 0,
                    'joiner': `"${this.joiner}"`,
                    'to': this.timeout*1000,
                    'prop': JSON.stringify(this.property),
                    'key': JSON.stringify(this.key),
                    'accum': JSON.stringify(!!this.accumulate),
                    'full': JSON.stringify(this.propertyType=='full')
                },
                func : code
            };
        }
    });
</script>
